<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>KAS PRO REALTIME</title>

<style>
body{font-family:Arial;margin:20px}
.admin{background:#e7f3ff;padding:10px;margin-top:20px}
.hidden{display:none}
</style>

</head>
<body>

<h2>LOGIN</h2>

<input type="password" id="password">
<button onclick="login()">Login</button>

<hr>

<div id="app" class="hidden">

<h3>Saldo Awal: <span id="saldoAwal">0</span></h3>
<h3>Total Masuk: <span id="totalMasuk">0</span></h3>
<h3>Total Keluar: <span id="totalKeluar">0</span></h3>

<h1>Sisa Kas: <span id="sisaKas">0</span></h1>

<div id="adminPanel" class="admin hidden">

<h3>SET SALDO AWAL (ADMIN ONLY)</h3>

<input id="inputSaldoAwal" type="number">
<button onclick="setSaldoAwal()">Simpan</button>

<hr>

<h3>Tambah Anggota</h3>

<input id="inputNamaAnggota">
<button onclick="tambahAnggota()">Tambah</button>

<hr>

<h3>Tambah Kas</h3>

<select id="selectAnggota"></select>
<input id="inputJumlahKas" type="number">
<button onclick="tambahKas()">Tambah</button>

<hr>

<h3>Tambah Pengeluaran</h3>

<input id="inputLokasi">
<input id="inputJumlahKeluar" type="number">
<button onclick="tambahPengeluaran()">Tambah</button>

</div>

</div>


<script type="module">

import { createClient } from "https://esm.sh/@supabase/supabase-js"

const supabase=createClient(
"https://tizsemvhdyykizevqsbl.supabase.co",
"sb_publishable_ZzxxlCc_IGlHAaeo4OU7Jg_EL5Yhdeq"
)

let role="anggota"


window.login=()=>{

if(password.value==="admin123") role="admin"

app.classList.remove("hidden")

if(role==="admin") adminPanel.classList.remove("hidden")

loadData()

}


async function loadData(){

// anggota
const {data:anggota}=await supabase
.from("anggota")
.select("*")

selectAnggota.innerHTML=
anggota.map(a=>`<option>${a.nama}</option>`).join("")


// saldo awal
const {data:config}=await supabase
.from("config_kas")
.select("*")
.single()

let saldoAwal=config?.dana_awal||0


// pemasukan
const {data:trx}=await supabase
.from("transaksi_kas")
.select("jumlah")

let totalMasuk=(trx||[])
.reduce((sum,r)=>sum+Number(r.jumlah),0)


// pengeluaran
const {data:out}=await supabase
.from("pengeluaran")
.select("jumlah")

let totalKeluar=(out||[])
.reduce((sum,r)=>sum+Number(r.jumlah),0)


let sisaKas=saldoAwal+totalMasuk-totalKeluar


saldoAwal.innerText=saldoAwal
totalMasuk.innerText=totalMasuk
totalKeluar.innerText=totalKeluar
sisaKas.innerText=sisaKas

}


// =====================
// ADMIN ACTION
// =====================

window.setSaldoAwal=async()=>{

if(role!=="admin") return alert("Admin only")

await supabase
.from("config_kas")
.upsert({id:1,dana_awal:inputSaldoAwal.value})

}

window.tambahAnggota=async()=>{

await supabase
.from("anggota")
.insert({nama:inputNamaAnggota.value})

}

window.tambahKas=async()=>{

await supabase
.from("transaksi_kas")
.insert({
bulan:new Date().getMonth()+1,
nama_anggota:selectAnggota.value,
jumlah:inputJumlahKas.value
})

}

window.tambahPengeluaran=async()=>{

await supabase
.from("pengeluaran")
.insert({
lokasi:inputLokasi.value,
tanggal:new Date(),
jumlah:inputJumlahKeluar.value
})

}


// =====================
// REALTIME AUTO SYNC
// =====================

supabase.channel("realtime-kas")

.on("postgres_changes",
{event:"*",schema:"public",table:"transaksi_kas"},
()=>loadData()
)

.on("postgres_changes",
{event:"*",schema:"public",table:"pengeluaran"},
()=>loadData()
)

.on("postgres_changes",
{event:"*",schema:"public",table:"config_kas"},
()=>loadData()
)

.on("postgres_changes",
{event:"*",schema:"public",table:"anggota"},
()=>loadData()
)

.subscribe()

</script>

</body>
</html>
